//- views/game/gameplay.pug
extends ../layout

block content
  .gameplay-page
    // Game Header
    .gameplay-header
      .gameplay-game-info
        h1= game.game_name
        p Game Code: #{game.game_code}
      .gameplay-status-info
        p Status: 
          span.gameplay-status-badge= game.status
        if game.status === 'completed' && game.winner_name
          p.gameplay-winner ğŸ† Winner: #{game.winner_name}

    .gameplay-main
      // Left Column: Player Status Panel
      .gameplay-sidebar
        .gameplay-card
          h2.gameplay-section-title ğŸ® Players
          
          #player-list.gameplay-player-list
            each player in players
              .gameplay-player-card(
                class=player.user_id === currentUser.user_id ? 'gameplay-current-player' : ''
                data-user-id=player.user_id
              )
                .gameplay-player-header
                  .gameplay-player-name-section
                    span.gameplay-player-name= player.username
                    if player.user_id === currentUser.user_id
                      span.gameplay-you-badge You
                  .turn-indicator(style='display: none;')
                    .gameplay-turn-dot

                .gameplay-player-stats
                  .gameplay-stat-item
                    span.gameplay-stat-label Position: 
                    span.gameplay-stat-value.position-value= player.current_position || 1
                  .gameplay-stat-item
                    span.gameplay-stat-label Score: 
                    span.gameplay-stat-value.score-value= player.score || 0

      // Right Column: Action Controls & Game State
      .gameplay-content
        
        // Action Controls Panel
        .gameplay-card.gameplay-controls
          h2.gameplay-section-title ğŸ¯ Game Controls
          
          // Current Turn Display
          #current-turn-display.gameplay-turn-display
            p#current-turn-text Loading...

          // Action Buttons
          .gameplay-actions
            
            // Roll Dice Section
            #roll-dice-section
              button#roll-dice-btn.gameplay-btn.gameplay-btn-primary.gameplay-btn-large(disabled)
                | ğŸ² Roll Dice
              #dice-result.gameplay-result-success(style='display: none;')
                p.gameplay-result-text You rolled: 
                  span#dice-value -
                p.gameplay-instruction-text#move-instruction -

            // QR Scanner Section  
            #qr-scanner-section.gameplay-scanner-section(style='display: none;')
              button#scan-qr-btn.gameplay-btn.gameplay-btn-secondary.gameplay-btn-large
                | ğŸ“± Scan QR Code
              #qr-result.gameplay-result-info(style='display: none;')
                p.gameplay-result-text Room confirmed! 
                p.gameplay-instruction-text Ready to answer question.

            // Question Section
            #question-section.gameplay-question-section(style='display: none;')
              .gameplay-question-card
                h3.gameplay-question-title Python Question:
                p#question-text.gameplay-question-text -
                .gameplay-answer-section
                  input#answer-input.gameplay-form-input(
                    type='text'
                    placeholder='Type your answer here...'
                  )
                  button#submit-answer-btn.gameplay-btn.gameplay-btn-warning.gameplay-btn-large
                    | âœ… Submit Answer

            // Answer Result
            #answer-result.gameplay-answer-result(style='display: none;')
              p#result-message.gameplay-result-message -
              p#result-explanation.gameplay-result-explanation -

        // Game State Display Panel  
        .gameplay-card.gameplay-log
          h2.gameplay-section-title ğŸ“œ Game Log
          
          #game-messages.gameplay-messages
            .gameplay-placeholder Game messages will appear here...

  // Winner Modal
  #winner-modal.gameplay-winner-modal(style='display: none;')
    .gameplay-winner-overlay
      .gameplay-winner-content
        .gameplay-winner-header
          h2.gameplay-winner-title ğŸ† Quest Complete!
          
        .gameplay-winner-body
          // Winner Announcement
          .gameplay-winner-announcement
            #winner-message.gameplay-winner-message Loading results...
            #winner-crown.gameplay-winner-crown ğŸ‘‘
            
          // Game Statistics
          .gameplay-winner-stats
            h3.gameplay-stats-title ğŸ“Š Final Statistics
            
            .gameplay-stats-grid
              .gameplay-stats-section
                h4.gameplay-stats-section-title Game Overview
                .gameplay-stats-list
                  .gameplay-stats-item
                    span.gameplay-stats-label Duration:
                    span#game-duration.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Total Moves:
                    span#total-moves.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Questions Asked:
                    span#total-questions.gameplay-stats-value -
                    
              .gameplay-stats-section
                h4.gameplay-stats-section-title Your Performance
                .gameplay-stats-list
                  .gameplay-stats-item
                    span.gameplay-stats-label Final Position:
                    span#player-position.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Final Score:
                    span#player-score.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Questions Answered:
                    span#player-questions.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Correct Answers:
                    span#player-correct.gameplay-stats-value -
                  .gameplay-stats-item
                    span.gameplay-stats-label Accuracy:
                    span#player-accuracy.gameplay-stats-value -
                    
            // Player Rankings
            .gameplay-rankings
              h4.gameplay-rankings-title ğŸ… Final Rankings
              #player-rankings.gameplay-rankings-list
                .gameplay-placeholder Loading rankings...

        .gameplay-winner-footer
          .gameplay-winner-actions
            button#return-dashboard-btn.gameplay-btn.gameplay-btn-primary.gameplay-btn-large
              | ğŸ  Return to Dashboard
            button#view-game-log-btn.gameplay-btn.gameplay-btn-secondary
              | ğŸ“œ View Game Log

  // Hidden data for JavaScript
  script(type='application/json', id='game-data')
    | !{JSON.stringify({gameId: game.game_id, userId: currentUser.user_id, players: players, gameStatus: game.status})}

block scripts
  // Socket.io client - CRITICAL: Must be loaded first
  script(src='/socket.io/socket.io.js')
  
  // External Libraries
  script(src='https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js')
  
  // Gameplay JavaScript - Load AFTER Socket.io
  script(src='/js/gameplay.js')